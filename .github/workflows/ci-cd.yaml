name: Deploy-Strapi-to-EC2

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # ----------------------------
    # 1. Checkout Code
    # ----------------------------
    - name: Checkout repository
      uses: actions/checkout@v4

    # ----------------------------
    # 2. Configure AWS credentials
    # ----------------------------
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ap-south-1

    # ----------------------------
    # 3. Login to ECR
    # ----------------------------
    - name: Login to Amazon ECR
      uses: aws-actions/amazon-ecr-login@v2

    # ----------------------------
    # 4. Build & Push Docker Image
    # ----------------------------
    - name: Build & Push Strapi image to ECR
      run: |
        ECR_REPO="${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.ap-south-1.amazonaws.com/strapi-app"
        IMAGE_TAG="${GITHUB_SHA}"

        echo "Building image: $ECR_REPO:$IMAGE_TAG"

        docker build \
          --build-arg PUBLIC_URL="http://${{ secrets.EC2_PUBLIC_IP }}" \
          -t $ECR_REPO:$IMAGE_TAG .

        docker push $ECR_REPO:$IMAGE_TAG

        echo "IMAGE=$ECR_REPO:$IMAGE_TAG" >> $GITHUB_ENV

    # ----------------------------
    # 5. Deploy on EC2 via SSH
    # ----------------------------
    - name: Deploy on EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_PUBLIC_IP }}
        username: ubuntu
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          echo "Logging in to AWS ECR…"
          
          # Install AWS CLI if missing
          if ! command -v aws &> /dev/null
          then
            echo "Installing AWS CLI…"
            sudo apt update -y
            sudo apt install -y awscli
          fi

          # Login to ECR from EC2
          aws ecr get-login-password --region ap-south-1 | \
            sudo docker login \
              --username AWS \
              --password-stdin ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.ap-south-1.amazonaws.com

          echo "Pulling latest image…"
          sudo docker pull ${{ env.IMAGE }}

          echo "Stopping old container…"
          sudo docker stop strapi || true
          sudo docker rm strapi || true

          echo "Starting new Strapi container…"

          sudo docker run -d \
            --name strapi \
            -p 80:1337 \
            -e NODE_ENV=production \
            -e PUBLIC_URL="http://${{ secrets.EC2_PUBLIC_IP }}" \
            -e APP_KEYS="${{ secrets.APP_KEYS }}" \
            -e API_TOKEN_SALT="${{ secrets.API_TOKEN_SALT }}" \
            -e ADMIN_JWT_SECRET="${{ secrets.ADMIN_JWT_SECRET }}" \
            -e JWT_SECRET="${{ secrets.JWT_SECRET }}" \
            -e TRANSFER_TOKEN_SALT="${{ secrets.TRANSFER_TOKEN_SALT }}" \
            -e ENCRYPTION_KEY="${{ secrets.ENCRYPTION_KEY }}" \
            -e DATABASE_CLIENT=postgres \
            -e DATABASE_HOST="${{ secrets.DB_HOST }}" \
            -e DATABASE_PORT=5432 \
            -e DATABASE_NAME="${{ secrets.DB_NAME }}" \
            -e DATABASE_USERNAME="${{ secrets.DB_USER }}" \
            -e DATABASE_PASSWORD="${{ secrets.DB_PASS }}" \
            -e AWS_REGION=ap-south-1 \
            -e AWS_S3_BUCKET="${{ secrets.S3_BUCKET }}" \
            -e AWS_ACCESS_KEY_ID="${{ secrets.S3_KEY }}" \
            -e AWS_SECRET_ACCESS_KEY="${{ secrets.S3_SECRET }}" \
            ${{ env.IMAGE }}

          echo "Deployment completed!"